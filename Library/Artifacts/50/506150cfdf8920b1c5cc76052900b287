s in room attribution issues: ${this.inRoomAttributionIssues}`)):this.inRoomAttributionIssues=null}if(this.hasProcessingMode(C.ProcessingMode.Transcript)||this.hasProcessingMode(C.ProcessingMode.ClosedCaptions)){const e=this.getTextTracksFromEndpointMetadata(a.endpointMetadata),t=!S(e,this.textTracks);this.textTracks=t?e:this.textTracks}}this.event("botStateChanged").raise(o)}catch(e){this.logger.error(`Error parsing Calling Bot metadata, ${g.CallingTelemetryService.getErrorMessage(e)}`)}}getTextTracksFromEndpointMetadata(e){var t,n;const i=[];return null===(n=null===(t=null==e?void 0:e.textTracks)||void 0===t?void 0:t.forEach)||void 0===n||n.call(t,(e=>{var t;(null===(t=null==e?void 0:e.translations)||void 0===t?void 0:t.length)>0?i.push(...this.getTextTracksFromEndpointMetadataTrackWithTranslations(e)):i.push(this.getTextTrackFromEndpointMetadataTrack(e))})),i.length>0?i:[this.getDefaultTrack()]}getTextTrackFromEndpointMetadataTrack(e){var t;return{language:null===(t=null==e?void 0:e.lang)||void 0===t?void 0:t.toLowerCase(),source:h(null==e?void 0:e.source)}}getTextTracksFromEndpointMetadataTrackWithTranslations(e){var t;const n=h(null==e?void 0:e.source);return null===(t=e.translations)||void 0===t?void 0:t.map((e=>({language:e,source:n})))}getDefaultTrack(){return{language:this.getSpokenLanguage(),source:a.Ai}}getConsumerType(){return this.config.isTflUser()?i.TeamsForLife:i.Teams}onBotAdded(e){this.bot=e,this.setStatus(C.CallingBotStatus.added),this.botSubscription=e.changed((()=>this.botStateChanged(e))),this.botStateChanged(e)}onBotChanged(e){this.bot&&this.onBotRemoved(),e&&this.onBotAdded(e)}getEndpointMetadataByProcessingMode(e,t){var n,i,a,o,r,s;for(const l of null!==(i=null===(n=null==e?void 0:e.endpoints)||void 0===n?void 0:n.endpointDetails)&&void 0!==i?i:[])if(null===(o=null===(a=null==l?void 0:l.endpointMetadata)||void 0===a?void 0:a.processingModes)||void 0===o?void 0:o[t])return null===(s=null===(r=null==l?void 0:l.endpointMetadata)||void 0===r?void 0:r.processingModes)||void 0===s?void 0:s[t];return null}findBotFromCall(){const e=[];for(const t of this.call.participants){const n=this.getEndpointMetadataByProcessingMode(t,this.processingMode);if(n){if((this.isAcsBot(t)?C.CallingBotType.AcsBot:C.CallingBotType.TeamsBot)!==this.botType)continue}(null==n?void 0:n.state)===C.ProcessingModeState.Active?e.unshift(t):n&&e.push(t)}return e[0]}isAcsBot(e){var t,n;return((null===(n=(t=this.config).getAcsBotMris)||void 0===n?void 0:n.call(t))||["28:6b45c5b6-1c34-47c0-8980-11e98d47d23f"]).includes(e.id)}subscribeToCall(){(0,p.safeSubscribeToCall)(this.call,(e=>{if(e.state===s.OX.Disconnected&&this.bot)return void this.onBotRemoved();const t=null!=this.processingMode?this.findBotFromCall():(0,l.find)(e.participants,(e=>e.id===this.botMRI));t!==this.bot&&(null!=t&&t.id!==this.botMRI&&(this.botMRI=t.id),this.onBotChanged(t))}),!0)}getMeetingOrganizer(e){let t;try{const n=new RegExp("context(.*?)(style|target)","g"),i=new RegExp('"Oid":"(.*?)"',"g"),a=n.exec(e)[1],o=decodeURIComponent(a);t=this.chatServiceUtils.getTeamsUserMriPrefix()+i.exec(decodeURIComponent(o))[1]}catch(e){this.logger.error(`Failed to decode meeting details invitation blob. ${g.CallingTelemetryService.getErrorMessage(e)}`),t=""}return t}fulfillBotPayloadForChannel(e,t,n){var i,a,o,s,l,c,d,g,u;return(0,r.__awaiter)(this,void 0,void 0,(function*(){let r,p,C;return(null===(i=t.enableT2AsyncChannelService)||void 0===i?void 0:i.call(t))?(p=yield null===(o=(a=this.channelService).getChannelByObjectIdAsync)||void 0===o?void 0:o.call(a,this.call.threadId),C=p?yield null===(l=(s=this.channelService).getTeamByObjectIdAsync)||void 0===l?void 0:l.call(s,p.parentTeamId||p.objectId):null):(p=null===(d=(c=this.channelService).getChannelByObjectId)||void 0===d?void 0:d.call(c,this.call.threadId),C=p?null===(u=(g=this.channelService).getTeamByObjectId)||void 0===u?void 0:u.call(g,p.parentTeamId):null),p&&C||(r=`Couldn't get teamName (${!!C}) or channelName (${!!p})`,this.logger.error(r),null==n||n.forEach((e=>{null==e||e.mark(m.Constants.scenarios.calling.recording.channelTeamNotFetched,{channel:!!p,team:!!C})}))),e.modernGroupId=C&&C.siteInfo&&C.siteInfo.groupId,e.teamName=C?C.displayName:this.callTitleService.defaultMeetingTitle,e.channelName=p?p.displayName:this.callTitleService.defaultMeetingTitle,e.meetingTitle=this.callTitleService.getMeetupTitleForCall(this.call)||e.meetingTitle,r}))}}},507744:(e,t,n)=>{n.r(t),n.d(t,{CallingBotCommand:()=>i,CallingBotCommandMode:()=>a,CallingBotCommandCallType:()=>o,CallingBotRestClient:()=>l});var i,a,o,r=n(142513),s=n(400010);!function(e){e.makeAllEntriesEdit="makeAllEntriesEdit",e.makeSingleEntryEdit="makeSingleEntryEdit",e.ovfdMessage="ovfdmessage",e.addLanguage="addLanguage",e.setLanguage="setLanguage",e.start="start",e.stop="stop",e.userSettingsUpdate="userSettingsUpdate",e.setUserToken="setUserToken",e.reportParticipant="editMisrecognizedParticipant"}(i||(i={})),function(e){e.transcription="transcription",e.cloudpeoplefeed="cloudpeoplefeed",e.recording="recording",e.combined="combined"}(a||(a={})),function(e){e.transcript="transcript",e.coach="coach",e.cloudpeoplefeed="cloudpeoplefeed",e.recording="recording"}(o||(o={}));class l{constructor(e,t,n){this.httpService=e,this.authenticationService=t,this.helpers=n}sendCommand(e,t,n,i,o,s,l,c,d,g,u){return(0,r.__awaiter)(this,void 0,void 0,(function*(){let p={timestamp:(new Date).toJSON(),participantMri:n,participantLegId:i,action:t,mode:c,processingModes:d,actionParameters:void 0};c===a.combined&&delete p.mode,g&&(p=Object.assign(Object.assign({},p),{actionParameters:Object.assign(Object.assign({},g),{type:t})}));try{const t=this.getOptions(o,s,l),n=yield this.getAuthenticationHeaders(!1,u),i=Object.assign(Object.assign({},t),{headers:Object.assign(Object.assign({},t.headers),n)});return yield this.httpService.post(e,i,p)}catch(e){throw yield function(e){return(0,r.__awaiter)(this,void 0,void 0,(function*(){try{if(e instanceof Response){const t