yOptions:o?JSON.parse(o):void 0})}}),a})(p,n,c);if(y){const{entity:e,command:t,entityOptions:i}=y;return!!sf({entity:e,command:t,entityOptions:i,windowId:g,clientLaunchId:h.correlation.clientLaunchId},Object.assign({appsRegistryService:a,cache:l,commandChangeReportingService:c,coreSettings:u,localStorage:d,windowId:g},m),s)}return v},rf=({logger:e,appsRegistryService:t,coreSettings:i})=>{const n=t.getDefaultCommand(i);return n?(e.log("Default command found"),n):(e.error("No default command defined"),null)},of=({isInputDefaultEntity:e,sourceWindow:t,context:i,userContextId:n,newEntity:r,matchedLinkedEntity:o,stateTransition:s,executionContext:a,correlation:l,logger:c})=>{var d;const{localStorage:u,coreSettings:g,appsRegistryService:m,commandChangeReportingService:h,clientPreferences:p}=i,{enableWriteActiveEntitiesToLocalStorage:v,enableMTMACommanding:y,enableWriteAppHistoryToLocalStorage:f}=g.get(b.J.Core);let S=null,k=!1;e&&t.isMainWindow&&v?S=((e,t,i,n)=>{var r;const o=e.get((0,bv.bM)(bv.WD,i),Go.f.Experience);if(o)try{const e=JSON.parse(o);return n&&i!==e.userContextId?null:Iv(e.activeEntities,t)}catch(e){null===(r=t.errorToTelemetry)||void 0===r||r.call(t,`Could not restore active entities from local storage. Stored string was in an invalid JSON format. String: ${o}`,"webclient_framework_foundation_core_services_entity_commanding",void 0,!0)}return null})(u,c,n,y):r.action===Ie.ukP.default&&t.isMainWindow&&f&&(S=((e,t,i,n,r)=>{var o,s;const a=null===(o=n.getApp({entityType:i}))||void 0===o?void 0:o.manifest.id,l=e.get((0,bv.bM)(`${bv.av}-${a}`,r),Go.f.Experience);if(l)try{return Iv(JSON.parse(l),t)}catch(e){null===(s=t.errorToTelemetry)||void 0===s||s.call(t,`Could not restore active entities from local storage. Stored string was in an invalid JSON format error ${e}`,"webclient_framework_foundation_core_services_entity_commanding",void 0,!0),t.log("String in local storage: ",l)}return null})(u,c,r.type,m,n));const w=Hp(t)?t.activeEntities:void 0;if(S){c.log("Got appViewEntities from local storage history: "),mv(S,c);const e=cf(S,m),i=cf(w,m),n=null===(d=null==e?void 0:e.onBeforeNavigationFromHistory)||void 0===d?void 0:d.call(e,S,{coreSettings:g,layoutMode:t.layoutConfig.layoutMode,userPreferences:vv(p)},(null==i?void 0:i.manifest.id)===(null==e?void 0:e.manifest.id)?w:void 0);k=!!n,k&&(c.log("App declared history invalid. New set of entities:"),mv(n,c)),S=n||S}else{const e=(({currentEntities:e,newEntity:t,matchedLinkedEntity:i,stateTransition:n,executionContext:r})=>!e||zy({entity:t,mainEntity:e.mainEntity,matchedLinkedEntity:i,stateTransition:n})||Hy({activeEntities:e,stateTransition:n,executionContext:r}))({currentEntities:w,newEntity:r,matchedLinkedEntity:o,stateTransition:s,executionContext:a});c.log(`Should use entity from command input for getAppViewEntities ${e} `);const{appEntity:i,contextEntity:n}=pv({currentEntities:Hp(t)?t.activeEntities:void 0,entity:r,shouldUseNewEntity:e});h.report({type:We.B.CommandBeforeGetAppViewEntities,context:{target:"executeEntityCommand"},correlationId:l.id});try{S=yv({appsRegistryService:m,clientPreferences:p,contextEntity:n,coreSettings:g,entity:i,layoutMode:t.layoutConfig.layoutMode}),(({appViewEntities:e,stateTransition:t,appEntity:i,linkedEntity:n})=>t!==ge.su.none&&null===e&&i===n)({appEntity:i,appViewEntities:S,linkedEntity:r.linkedEntity,stateTransition:s})&&(c.log(`Initial getAppViewEntities for ${i} returned null`),S=yv({entity:r,clientPreferences:p,contextEntity:null,coreSettings:g,layoutMode:t.layoutConfig.layoutMode,appsRegistryService:m}))}catch(e){h.report({type:We.B.Failure,context:{errorInfo:$e.y.CommandGetAppViewEntitiesFailure,errorMessage:e.message,target:"executeEntityCommand"},correlationId:l.id})}}return{appViewEntities:S,isCurrentEntitiesInvalid:k}},sf=({clientLaunchId:e,command:t,entity:i,entityOptions:n,executionContext:r,windowId:o,windowOptions:s},a,l)=>{var c,d,u,g,m,h,p,v;const{appsRegistryService:y,authenticationUser:f,cache:k,clientPreferences:w,commandChangeReportingService:C,coreSettings:_,experienceChangeReportingService:T,loggerFactory:I,notificationsHandler:j,windowProvider:N,scenarioFactory:E}=a,A=I.newLogger("executeEntityCommand-mutation","data-client-entity-command"),{visibilityState:x,stateTransition:D,correlation:M,layoutMode:O}=t;try{const v=o||S.ew,I=((e,t)=>t?Object.assign(Object.assign({},t),{clientLaunchId:null!=e?e:null,__typename:"Correlation"}):Object.assign(Object.assign({},Yp()),{clientLaunchId:null!=e?e:null,__typename:"Correlation"}))(null!=e?e:null,M);C.report({correlationId:I.id,type:We.B.CommandResolutionStarted,context:{target:"executeEntityCommand"}});const F=Ov(k,A),[R,P]=Wp(F,$p,(e=>!Uv(F,e.id)&&!((e,t)=>{const i=Lv(e,ge.lO.minimal);return t===(null==i?void 0:i.id)})(F,e.id)&&!((e,t)=>{const i=Lv(e,ge.lO.minimode);return t===(null==i?void 0:i.id)})(F,e.id))),L=(e=>e.action===ue.u.default&&e.type===ue.p.default)(i),B=null==M?void 0:M.sourceHint,W=(({entity:e,isInputDefaultEntity:t,logger:i,appsRegistryService:n,coreSettings:r})=>t?rf({logger:i,appsRegistryService:n,coreSettings:r}):e)({entity:i,isInputDefaultEntity:L,logger:A,appsRegistryService:y,coreSettings:_});if(!W)return null===(c=A.errorToTelemetry)||void 0===c||c.call(A,"Unable to use entity from command input",Py,void 0,!0),null;const $=Zp(W,n,s);if(function(e){return e.type===ue.p.toasts}($))return(({activeWindows:e,context:t,command:i,correlation:n,entity:r,entityOptions:o,logger:s,notificationsHandler:a,newEntity:l})=>{var c,d,u;let g,m;try{o&&(g=JSON.parse(o))}catch(e){null===(c=s.errorToTelemetry)||void 0===c||c.call(s,"CN:Ignoring error while parsing entity options for toasts.","webclient_framework_foundation_resolvers_notifications",void 0,!0)}if(a.isInAppNotificationsEnabled()){const a=Wv(e,S.ew);if(!a)return null===(d=s.errorToTelemetry)||void 0===d||d.call(s,"Error occured trying to execute notifications command, targetWindow is not found","webclient_framework_foundation_resolvers_notifications",void 0,!0),null;let l=!1,c=!1;return r.action===ue.u.view&&(i.visibilityState===Ie.feW.hide&&(null===(u=a.activeEntities.inAppNotificationsEntity)||void 0===u?void 0:u.type)===r.type?(a.activeEntities=Object.assign(Object.assign({},a.activeEntities),{inAppNotificationsEntity:null}),c=!0):i.visibilityState===Ie.feW.show&&(a.activeEntities=Object.assign(Object.assign({},a.activeEntities),{inAppNotificationsEntity:{id:r.id||n.id,action:r.action,type:r.type,entityState:{flushableByLinkedEntity:!1,__typename:"EntityState"},linkedEntity:null,options:o||null,windowOptions:null,__typename:"Entity"}}),c=!0)),l=c&&Fv(t,e,a,s),l&&Hp(a)?a:null}if(!a.isCustomNotificationsEnabled(g))return a.sendCommandToHost(i,n.id,r,g),null;const h=e.findIndex((e=>!0===e.isNotificationsWindow));return m=-1===h?Ry(n,null):e[h],l.id=(0,Be.v4)(),((e,t)=>{t.activeEntities.mainEntity=e})(l,m),Fv(t,e,m,s,n.id)?m:null})({activeWindows:F,context:a,command:t,correlation:I,entity:i,entityOptions:n,logger:A,notificationsHandler:j,newEntity:$});A.log(`Command received for entity ${cv($)}`),A.log(`Command received :${function(e){return`{\n    visibilityState: ${e.visibilityState},\n    stateTransition: ${e.stateTransition},\n    correlation: ${dv(e.correlation)}\n  }`}(t)}`),A.log(`Command with id ${I.id} received on window context ${v}`),A.log(`Command received with execution context: ${null==r?void 0:r.viewEntityName}`);const{isNewContextSupportEnabled:H,webNrcEnabled:z}=_.get(b.J.Host),{enableMultiSlotHide:q,enableMultiSlotNone:V,enableWindowNotUpdatedEvent:G,enableMTMACommanding:J,forceFocusLayoutMode:Q,enableWindowHistoryRestorationOnStandardMain:K,enableT21WebNewContextsOverride:Y,enableEmptyWindowDialogForDeeplink:X}=_.get(b.J.Core),Z=Lv(F,Ie.lOW.standard),ee=J&&((null==r?void 0:r.userContextId)||nv(f)||D===Ie.suD.extend&&Z&&Z.userContextId)||null;A.log(`isNewContextSupportEnabled ${H}, enableMultiSlotHide ${q}, enableMultiSlotNone ${V}`);let te=H;H||Y&&$.type===ue.p.brbfeedbackdialog&&(te=!0);const ne=((e,t)=>t?ge.lO.focus:e&&(e.layoutMode||ge.lO.focus))(N.Cypress,!!Q),re=Zy({activeWindows:F,command:t,coreSettings:_,correlation:I,entitiesMap:R,entity:$,isNewContextSupportEnabled:null==te||te,layoutMode:null!=ne?ne:O,linkedEntitiesMap:P,logger:A,userContextId:ee,windowId:v,webNrcEnabled:null!=z&&z});let[oe]=re;const[,se]=re;let ae=!1;if(K&&oe&&!Hp(oe)&&oe.isMainWindow&&oe.layoutConfig.layoutMode===Ie.lOW.standard&&(oe=((e,t,i,n,r)=>{var o,s;const a=t.get((0,bv.bM)(bv.Hs,n),Go.f.Experience);if(a)try{const l=JSON.parse(a);if(r&&n!==l.userContextId)return null===(o=i.warnToTelemetry)||void 0===o||o.call(i,"User context of window doesn't match user context of stored history","webclient_framework_foundation_core_services_entity_commanding",void 0,!0),e;const c=parseInt(l.windowHistoryIndex,10);if(isNaN(c))return null===(s=i.warnToTelemetry)||void 0===s||s.call(i,`Store window history has invalid history index. CurrentWindowHistoryIndex ${l.windowHistoryIndex}`,"webclient_framework_foundation_core_services_entity_commanding",void 0,!0),e;const d=t.get((0,bv.bM)(bv.ax,n),Go.f.Experience);if(d){const t=jv(JSON.parse(d),i);return Object.assign(Object.assign({},e),{windowHistory:t,currentWindowHistoryIndex:c})}i.warn("Could not restore hi